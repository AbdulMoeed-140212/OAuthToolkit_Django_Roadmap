# How to oAuth toolkit

## What is oAuth toolkit?

oAuth toolkit is a python package that extends  [oauthlib](https://github.com/oauthlib/oauthlib) for Django framework. It contains basic implementation of oAuth1, oAuth2 and OpenID connect protocols. 

## What is in it?

- A complete set of rest apis for authorization, token exchange, revoke token, token introspect,
- Application management
- Scope management
- Remote user verification
- OpenID support
- OAuth2 flows [authorization code, client credentials, legacy password, hybrid]
- DRF support

## Where to start?

If you are new to oauth toolkit try out the [toutorial](https://django-oauth-toolkit.readthedocs.io/en/latest/tutorial/tutorial.html), after that lets start with planning out for project structure. After you know what are your targets explore `oauth_provider.models.py` and figure out if existing models suit your needs. All models are swapable they can be inherited to a custom model class and used in place of existing one. 

The reason I'm starting with this is 

1. This is a 2 step process first the migrations are done and then changes in settings.py are applied. doing them in one go did go well for me
2. After a successful swap, you might lose access to existing data, Data needs to be transferred separately

Also the documentation are show one example here is a sample code for Configuring all models

This is how models are configured in oauth toolkit

```python
# oauth_provider/settings.py
APPLICATION_MODEL = getattr(settings, "OAUTH2_PROVIDER_APPLICATION_MODEL", "oauth2_provider.Application")
ACCESS_TOKEN_MODEL = getattr(settings, "OAUTH2_PROVIDER_APPLICATION_MODEL", "oauth2_provider.AccessToken")
ID_TOKEN_MODEL = getattr(settings, "OAUTH2_PROVIDER_ID_TOKEN_MODEL", "oauth2_provider.IDToken")
GRANT_MODEL = getattr(settings, "OAUTH2_PROVIDER_GRANT_MODEL", "oauth2_provider.Grant")
REFRESH_TOKEN_MODEL = getattr(settings, "OAUTH2_PROVIDER_REFRESH_TOKEN_MODEL", "oauth2_provider.RefreshToken")
```

This how models can be reconfigured, make sure new models inherit class with 'Abstract' prefix ([official example](https://django-oauth-toolkit.readthedocs.io/en/latest/advanced_topics.html#extending-the-application-model)) 

```python
# customapp/settings.py
OAUTH2_PROVIDER_APPLICATION_MODEL = "customapp.Application"
OAUTH2_PROVIDER_APPLICATION_MODEL = "customapp.AccessToken"
OAUTH2_PROVIDER_ID_TOKEN_MODEL = "customapp.IDToken"
OAUTH2_PROVIDER_GRANT_MODEL = "customapp.Grant"
OAUTH2_PROVIDER_REFRESH_TOKEN_MODEL = "customapp.RefreshToken"
```

## What next?

Next should be integrating oauth urls in your url configuration. I recommend to include oauth_provider.urls in root url.py of the project. The default url coniguration will contain Application and token management pages. If they are not required they can be removed as follows

```python
# rootapp/urls.py
from django.contrib import admin
from django.urls import include, path
from oauth2_provider.urls import base_urlpatterns, oidc_urlpatterns, app_name as oauth_appname


urlpatterns = [
    path('admin/', admin.site.urls),
    path('o/', include((base_urlpatterns + oidc_urlpatterns, oauth_appname), namespace=oauth_appname)),
]
```

The special thing about this is that namespace of oauth_toolkit urls is the same , that means the reverse will work properly and internal library reverse will not break. It looks tempting to put this in some app other than root, this will cause a conflict in namespace and may break something inside oauth toolkit.

## The Auth Flows

Oauth toolkit supports 4 authorization flows

1. Authorization Code flow
2. Client Credential flow
3. Legacy Password flow
4. Hybrid flow

### Authorization  Code flow

The most commonly used flow, that goes like this authentication --> token --> access tokenwith some url redirects. Access Token represents a user

### Client Credential flow

This is for inter service communication, an app can authenticate with `client_id` and `client_secret` . Used in resource server for introspection. Token generated by this does not represent a user.

### Legacy Password flow

This is depreciated it is a basic flow that exchanges user credentials and token in one transaction. This flow is not recommend but it will work for monolith application

### Hybrid flow

This is for a case where backend and frontend need 2 separate tokens, it is same as Authorization Code flow but with an  extra token exchange for frontend. Before working on this make sure you know about URL [fragment](https://en.wikipedia.org/wiki/URI_fragment).



